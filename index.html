<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoStudy: Smart Learning</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // Custom Tailwind theme configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#22543D', // Dark Forest Green
                            'dark': '#1A4331', // Darker
                            'light': '#38A169', // Lighter Green
                        },
                        secondary: '#F0FFF4', // Very light green
                        accent: '#F6E05E', // Yellow accent
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                },
            },
        };
    </script>

    <style>
        /* Small style tweaks */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        /* Active nav item style */
        .nav-item.active {
            background-color: #1A4331; /* primary-dark */
            box-shadow: inset 3px 0 0 0 #F6E05E; /* accent */
        }
        /* Chat bubble styles */
        .chat-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word; /* Ensure long words break */
        }
        .chat-bubble-user {
            background-color: #38A169; /* primary-light */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .chat-bubble-bot {
            background-color: #E2E8F0;
            color: #1A202C;
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        /* Bot typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            background-color: #909090;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.15s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.3s;
        }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 50%;
            background-color: #e2e8f0; /* Default gray */
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .badge-bronze { background-color: #CD7F32; color: white; }
        .badge-silver { background-color: #C0C0C0; color: white; }
        .badge-gold { background-color: #FFD700; color: #4A5568; }
        .badge-platinum { background-color: #E5E4E2; color: #2D3748; border-color: #a0aec0; }
        .badge-emerald { background-color: #2ECC71; color: white; }

        /* Calculator Result */
        #calculator-result {
            transition: opacity 0.5s ease-in-out;
        }
        /* Challenge Joined Message */
        #challenge-message {
            transition: opacity 0.5s ease-in-out;
        }

        /* Module Item Disabled Look */
        .module-item[disabled] {
            cursor: not-allowed;
            opacity: 0.6;
        }
         /* Style for course search input */
        #course-search {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-search'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.3-4.3'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            padding-left: 2.5rem; /* Adjust based on icon size and desired spacing */
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- LOGIN PAGE -->
    <div id="login-page" class="fixed inset-0 z-50 flex h-screen w-screen items-center justify-center bg-secondary">
        <div class="w-full max-w-md rounded-xl bg-white p-8 shadow-2xl">
            <div class="mb-6 flex flex-col items-center">
                <i data-lucide="leaf" class="h-16 w-16 text-primary"></i>
                <h1 class="mt-4 text-3xl font-bold text-primary">EcoStudy</h1>
                <p class="text-gray-600">Smart Learning for a Greener Future</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="mb-2 block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" value="student@ecostudy.com" class="w-full rounded-lg border-gray-300 p-3 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="mb-2 block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" value="password" class="w-full rounded-lg border-gray-300 p-3 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50" required>
                </div>
                <button type="submit" class="flex w-full items-center justify-center rounded-lg bg-primary p-3 text-lg font-semibold text-white shadow-lg transition duration-300 ease-in-out hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light focus:ring-opacity-75">
                    <i data-lucide="log-in" class="mr-2 h-5 w-5"></i>
                    Login
                </button>
            </form>
            <p class="mt-6 text-center text-sm text-gray-500">
                Don't have an account? <a href="#" class="font-medium text-primary-light hover:underline">Sign up</a>
            </p>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="main-app" class="hidden h-screen md:flex">

        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="fixed z-40 h-full w-64 -translate-x-full transform bg-primary text-white shadow-lg transition-transform duration-300 ease-in-out md:relative md:translate-x-0">
            <!-- Logo -->
            <div class="flex h-20 items-center justify-center px-6">
                <i data-lucide="leaf" class="h-8 w-8"></i>
                <span class="ml-3 text-2xl font-bold">EcoStudy</span>
            </div>
            <!-- Nav Links -->
            <ul class="flex flex-col space-y-2 p-4">
                <li><a href="#" class="nav-item active flex items-center rounded-lg p-3 transition-colors duration-200 hover:bg-primary-dark" data-page="dashboard"><i data-lucide="layout-dashboard" class="h-5 w-5"></i><span class="ml-4 font-medium">Dashboard</span></a></li>
                <li><a href="#" class="nav-item flex items-center rounded-lg p-3 transition-colors duration-200 hover:bg-primary-dark" data-page="materials"><i data-lucide="book-open" class="h-5 w-5"></i><span class="ml-4 font-medium">Study Materials</span></a></li>
                <li><a href="#" class="nav-item flex items-center rounded-lg p-3 transition-colors duration-200 hover:bg-primary-dark" data-page="calculator"><i data-lucide="calculator" class="h-5 w-5"></i><span class="ml-4 font-medium">Carbon Calculator</span></a></li>
                <li><a href="#" class="nav-item flex items-center rounded-lg p-3 transition-colors duration-200 hover:bg-primary-dark" data-page="ecobot"><i data-lucide="bot" class="h-5 w-5"></i><span class="ml-4 font-medium">EcoBot</span></a></li>
                <li><a href="#" class="nav-item flex items-center rounded-lg p-3 transition-colors duration-200 hover:bg-primary-dark" data-page="leaderboard"><i data-lucide="trophy" class="h-5 w-5"></i><span class="ml-4 font-medium">Leaderboard</span></a></li>
            </ul>
        </nav>

        <!-- Mobile Overlay -->
        <div id="overlay" class="fixed inset-0 z-30 hidden bg-black/50 md:hidden"></div>

        <!-- Main Content Area -->
        <div class="flex flex-1 flex-col overflow-hidden">
            <!-- Content Header -->
            <header class="flex h-20 w-full items-center justify-between border-b bg-white p-6 shadow-sm">
                <div class="flex items-center">
                    <button id="burger-btn" class="mr-4 rounded-md p-2 text-gray-600 md:hidden"><i data-lucide="menu" class="h-6 w-6"></i></button>
                    <h1 id="page-title" class="text-3xl font-bold text-gray-800">Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center rounded-full bg-secondary p-2 pr-4 shadow-inner">
                        <i data-lucide="leaf" class="h-6 w-6 text-primary-light"></i>
                        <span class="ml-2 font-semibold text-primary"><span id="green-points-display">1250</span> GP</span>
                    </div>
                    <div class="relative">
                        <button id="user-menu-button">
                            <img id="user-avatar-header" src="https://placehold.co/40x40/38A169/FFFFFF?text=S" alt="User Avatar" class="h-10 w-10 rounded-full border-2 border-primary-light transition-transform duration-200 hover:scale-105">
                        </button>
                        <div id="user-menu-dropdown" class="absolute right-0 z-50 mt-2 w-56 origin-top-right rounded-xl bg-white py-2 shadow-lg ring-1 ring-black ring-opacity-5 hidden">
                            <div class="border-b px-4 py-3">
                                <p id="dropdown-username" class="text-sm font-medium text-gray-900">Student</p>
                                <p id="dropdown-email" class="truncate text-sm text-gray-500">student@ecostudy.com</p>
                            </div>
                            <ul class="py-1">
                                <li><a href="#" class="nav-item flex w-full items-center px-4 py-2 text-sm text-gray-700 transition-colors hover:bg-gray-100" data-page="profile"><i data-lucide="user" class="mr-3 h-5 w-5 text-gray-500"></i> My Profile</a></li>
                                <li><a href="#" id="switch-account-button" class="flex w-full items-center px-4 py-2 text-sm text-gray-700 transition-colors hover:bg-gray-100"><i data-lucide="users" class="mr-3 h-5 w-5 text-gray-500"></i> Switch Account</a></li>
                            </ul>
                            <ul class="border-t py-1">
                                <li><a href="#" id="logout-button" class="flex w-full items-center px-4 py-2 text-sm text-red-600 transition-colors hover:bg-red-50"><i data-lucide="log-out" class="mr-3 h-5 w-5"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main id="content-area" class="flex-1 overflow-y-auto bg-gray-100 p-6 md:p-10">

                <!-- DASHBOARD PAGE -->
                <div id="page-dashboard" class="page-content space-y-8">
                    <h2 class="text-2xl font-semibold text-gray-700">Welcome back, <span id="welcome-username">Student</span>!</h2>
                    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
                        <div class="rounded-xl bg-white p-6 shadow-lg"><div class="flex items-center justify-between"><span class="text-sm font-medium text-gray-500">Green Points</span><i data-lucide="leaf" class="h-6 w-6 text-primary-light"></i></div><p id="dashboard-gp" class="mt-2 text-3xl font-bold text-gray-800">1250</p></div>
                        <div class="rounded-xl bg-white p-6 shadow-lg"><div class="flex items-center justify-between"><span class="text-sm font-medium text-gray-500">Courses Completed</span><i data-lucide="check-circle" class="h-6 w-6 text-blue-500"></i></div><p class="mt-2 text-3xl font-bold text-gray-800">5</p></div>
                        <div class="rounded-xl bg-white p-6 shadow-lg"><div class="flex items-center justify-between"><span class="text-sm font-medium text-gray-500">Files Uploaded</span><i data-lucide="file-up" class="h-6 w-6 text-indigo-500"></i></div><p id="dashboard-files" class="mt-2 text-3xl font-bold text-gray-800">12</p></div>
                        <div class="rounded-xl bg-white p-6 shadow-lg"><div class="flex items-center justify-between"><span class="text-sm font-medium text-gray-500">EcoBot Chats</span><i data-lucide="bot" class="h-6 w-6 text-pink-500"></i></div><p class="mt-2 text-3xl font-bold text-gray-800">42</p></div>
                    </div>
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                        <div class="rounded-xl bg-white p-6 shadow-lg lg:col-span-2"><h3 class="mb-4 text-xl font-semibold text-gray-700">Quick Access</h3><div class="grid grid-cols-1 gap-4 sm:grid-cols-2"><a href="#" class="nav-item flex items-center rounded-lg bg-secondary p-4 transition hover:bg-green-100" data-page="materials"><i data-lucide="book-open" class="h-8 w-8 text-primary"></i><div class="ml-4"><h4 class="font-bold text-primary">Study Materials</h4><p class="text-sm text-gray-600">Browse your courses and files</p></div></a><a href="#" class="nav-item flex items-center rounded-lg bg-secondary p-4 transition hover:bg-green-100" data-page="ecobot"><i data-lucide="bot" class="h-8 w-8 text-primary"></i><div class="ml-4"><h4 class="font-bold text-primary">Chat with EcoBot</h4><p class="text-sm text-gray-600">Ask questions and get help</p></div></a><a href="#" class="nav-item flex items-center rounded-lg bg-secondary p-4 transition hover:bg-green-100" data-page="calculator"><i data-lucide="calculator" class="h-8 w-8 text-primary"></i><div class="ml-4"><h4 class="font-bold text-primary">Carbon Calculator</h4><p class="text-sm text-gray-600">Estimate your footprint</p></div></a></div></div>
                        <div class="rounded-xl bg-white p-6 shadow-lg"><h3 class="mb-4 text-xl font-semibold text-gray-700">Offline Learning</h3><div class="flex items-center justify-between"><span class="text-gray-600">Enable Offline Mode</span><label for="offline-toggle" class="relative inline-flex cursor-pointer items-center"><input type="checkbox" id="offline-toggle" class="peer sr-only"><div class="peer h-6 w-11 rounded-full bg-gray-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-primary-light peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-200"></div></label></div><p class="mt-4 text-sm text-gray-500">This will download essential materials.</p></div>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="rounded-xl bg-white p-6 shadow-lg">
                            <div class="flex items-center">
                                <i data-lucide="target" class="h-6 w-6 text-primary-light"></i>
                                <h3 class="ml-3 text-xl font-semibold text-gray-700">Eco Challenges (+5 GP each)</h3>
                            </div>
                            <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                <div class="rounded-lg border border-gray-200 p-4">
                                    <div class="flex items-center"><i data-lucide="recycle" class="h-6 w-6 text-blue-500"></i><h4 class="ml-2 font-semibold text-gray-800">Plastic Free Week</h4></div>
                                    <p class="mt-2 text-sm text-gray-600">Avoid single-use plastics for 7 days.</p>
                                    <button class="join-challenge-btn mt-3 w-full rounded-md bg-blue-100 px-3 py-1 text-sm font-medium text-blue-700 transition hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed" data-challenge-name="Plastic Free Week">Join Challenge</button>
                                </div>
                                <div class="rounded-lg border border-gray-200 p-4">
                                    <div class="flex items-center"><i data-lucide="droplet" class="h-6 w-6 text-teal-500"></i><h4 class="ml-2 font-semibold text-gray-800">5-Minute Showers</h4></div>
                                    <p class="mt-2 text-sm text-gray-600">Keep showers under 5 minutes this week.</p>
                                    <button class="join-challenge-btn mt-3 w-full rounded-md bg-teal-100 px-3 py-1 text-sm font-medium text-teal-700 transition hover:bg-teal-200 disabled:opacity-50 disabled:cursor-not-allowed" data-challenge-name="5-Minute Showers">Join Challenge</button>
                                </div>
                                <div class="rounded-lg border border-gray-200 p-4">
                                    <div class="flex items-center"><i data-lucide="carrot" class="h-6 w-6 text-orange-500"></i><h4 class="ml-2 font-semibold text-gray-800">Meatless Monday</h4></div>
                                    <p class="mt-2 text-sm text-gray-600">Go vegetarian or vegan for one day.</p>
                                    <button class="join-challenge-btn mt-3 w-full rounded-md bg-orange-100 px-3 py-1 text-sm font-medium text-orange-700 transition hover:bg-orange-200 disabled:opacity-50 disabled:cursor-not-allowed" data-challenge-name="Meatless Monday">Join Challenge</button>
                                </div>
                            </div>
                            <p id="challenge-message" class="mt-4 text-center text-sm font-medium text-primary hidden opacity-0"></p> <!-- Message area -->
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6"><div class="rounded-xl bg-white p-6 shadow-lg"><div class="flex items-center"><i data-lucide="sparkles" class="h-6 w-6 text-accent"></i><h3 class="ml-3 text-xl font-semibold text-gray-700">âœ¨ Eco-Tip of the Day</h3></div><div id="eco-tip-content" class="mt-4 text-gray-600"><div id="eco-tip-loader" class="space-y-2"><div class="h-4 w-full animate-pulse-slow rounded bg-gray-200"></div><div class="h-4 w-3/4 animate-pulse-slow rounded bg-gray-200"></div></div><p id="eco-tip-text" class="hidden"></p><p id="eco-tip-error" class="hidden text-red-500">Could not load tip.</p></div></div></div>
                </div>

                <!-- STUDY MATERIALS PAGE -->
                <div id="page-materials" class="page-content hidden space-y-6">
                    <!-- Main Content Section -->
                    <div id="materials-main-view" class="space-y-6">
                        <h2 class="text-2xl font-semibold text-gray-700">My Courses</h2>

                        <!-- Search Bar -->
                        <div class="relative mb-2"> <!-- Added margin-bottom -->
                             <input type="search" id="course-search" placeholder="Search all courses (e.g., 'climate', 'ocean')..." class="w-full rounded-lg border-gray-300 p-3 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50">
                        </div>
                        <p class="text-sm text-gray-500 -mt-4 mb-6">Showing featured courses. Use search to find more.</p> <!-- Added note below search -->


                        <!-- Course Grid Container -->
                        <div id="course-grid-container" class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                            <!-- Course cards will be dynamically inserted here -->
                        </div>
                        <p id="no-courses-message" class="hidden text-center text-gray-500 mt-4">No courses match your search.</p>

                        <div class="my-8 border-t border-gray-200"></div>

                        <!-- File Uploads Section -->
                        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                            <div class="rounded-xl bg-white p-6 shadow-lg lg:col-span-1"><h3 class="mb-4 text-xl font-semibold text-gray-700">Upload New File (+10 GP)</h3><input type="file" id="file-upload" class="hidden" multiple><div id="dropzone" class="flex h-48 cursor-pointer flex-col items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 transition hover:border-primary-light hover:bg-secondary"><i data-lucide="upload-cloud" class="h-12 w-12 text-gray-400"></i><p class="mt-2 text-sm text-gray-600">Drag & drop files here</p><p class="text-xs text-gray-500">or click to browse</p></div></div>
                            <div class="rounded-xl bg-white shadow-lg lg:col-span-2"><h3 class="border-b p-6 text-xl font-semibold text-gray-700">My Uploaded Files</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-sm font-semibold text-gray-600">Name</th><th class="px-4 py-3 text-sm font-semibold text-gray-600">Type</th><th class="px-4 py-3 text-sm font-semibold text-gray-600">Size</th><th class="px-4 py-3 text-sm font-semibold text-gray-600">Actions</th></tr></thead><tbody id="file-list" class="divide-y divide-gray-200"><tr class="hover:bg-gray-50"><td class="flex items-center px-4 py-3"><i data-lucide="file-text" class="h-5 w-5 text-gray-500"></i><span class="ml-3 font-medium text-gray-800">Ecology_Final_Notes.pdf</span></td><td class="px-4 py-3 text-sm text-gray-600">PDF Document</td><td class="px-4 py-3 text-sm text-gray-600"> 2.5 MB <span class="text-xs text-gray-500">(from 4.1 MB)</span></td><td class="px-4 py-3"><button class="rounded-md p-2 text-gray-500 transition hover:bg-gray-100 hover:text-primary"><i data-lucide="download" class="h-5 w-5"></i></button><button class="delete-file-btn rounded-md p-2 text-gray-500 transition hover:bg-red-100 hover:text-red-600 ml-1"><i data-lucide="trash-2" class="h-5 w-5"></i></button></td></tr><tr class="hover:bg-gray-50"><td class="flex items-center px-4 py-3"><i data-lucide="image" class="h-5 w-5 text-gray-500"></i><span class="ml-3 font-medium text-gray-800">Food_Web_Diagram.png</span></td><td class="px-4 py-3 text-sm text-gray-600">Image</td><td class="px-4 py-3 text-sm text-gray-600"> 0.8 MB <span class="text-xs text-gray-500">(from 1.5 MB)</span></td><td class="px-4 py-3"><button class="rounded-md p-2 text-gray-500 transition hover:bg-gray-100 hover:text-primary"><i data-lucide="download" class="h-5 w-5"></i></button><button class="delete-file-btn rounded-md p-2 text-gray-500 transition hover:bg-red-100 hover:text-red-600 ml-1"><i data-lucide="trash-2" class="h-5 w-5"></i></button></td></tr></tbody></table></div></div>
                        </div>
                    </div>

                     <!-- Course Details View (Initially hidden) -->
                     <div id="course-details-view" class="hidden space-y-6">
                        <button id="back-to-courses-btn" class="flex items-center text-sm font-medium text-gray-600 transition hover:text-primary"><i data-lucide="arrow-left" class="mr-2 h-4 w-4"></i> Back to Study Materials</button>
                        <div class="rounded-xl bg-white p-6 shadow-lg"><h2 id="course-detail-title" class="text-3xl font-bold text-gray-800"></h2><p id="course-detail-desc" class="mt-2 text-gray-600"></p><div class="mt-4"><span class="text-xs font-semibold text-gray-500">Progress</span><div class="mt-1 w-full rounded-full bg-gray-200"><div id="course-detail-progress" class="rounded-full p-0.5 text-center text-xs font-medium leading-none text-white transition-all duration-500"></div></div></div></div>
                        <div class="grid grid-cols-1 gap-6 lg:grid-cols-4">
                            <div class="rounded-xl bg-white shadow-lg lg:col-span-1"><h3 class="border-b p-4 text-lg font-semibold text-gray-700">Course Modules (+50 GP each)</h3><ul id="course-module-list" class="divide-y divide-gray-200 p-2"></ul></div>
                            <!-- Updated Main Content Area -->
                            <div class="rounded-xl bg-white shadow-lg lg:col-span-3">
                                <h3 id="course-content-title" class="border-b p-6 text-xl font-semibold text-gray-700"></h3>
                                <div class="p-6 space-y-4">
                                    <!-- Video Placeholder -->
                                    <div id="video-player-placeholder" class="aspect-video w-full rounded-lg bg-gray-900 flex flex-col items-center justify-center text-white mb-4"> <!-- Added margin-bottom -->
                                        <i data-lucide="video" class="h-16 w-16 text-white/70"></i>
                                        <p class="mt-2 text-sm">Video content for this module will appear here.</p>
                                    </div>
                                    <!-- Lesson Text -->
                                    <h4 class="text-lg font-semibold text-gray-800">About this lesson</h4>
                                    <p id="course-content-text" class="text-gray-600 leading-relaxed"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARBON CALCULATOR PAGE -->
                <div id="page-calculator" class="page-content hidden space-y-6">
                     <div class="rounded-xl bg-white p-6 text-center shadow-lg"><i data-lucide="footprints" class="mx-auto h-16 w-16 text-primary"></i><h2 class="mt-4 text-3xl font-bold text-gray-800">Carbon Footprint Calculator</h2><p class="mt-2 text-gray-600">Get a simple estimate of your environmental impact.</p><p class="mt-1 text-xs text-gray-500">(Simplified calculation for educational purposes.)</p></div>
                     <form id="carbon-calculator-form" class="rounded-xl bg-white p-8 shadow-lg space-y-6">
                        <div><label for="commute" class="block text-lg font-semibold text-gray-700 mb-2">1. Primary Commute?</label><select id="commute" name="commute" class="w-full rounded-lg border-gray-300 p-3 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50"><option value="walk_bike">Walk / Bike</option><option value="public_transport">Public Transport</option><option value="electric_vehicle">Electric Vehicle</option><option value="gas_car_small">Gas Car (Small)</option><option value="gas_car_large" selected>Gas Car (Large/SUV)</option></select></div>
                        <div><label for="diet" class="block text-lg font-semibold text-gray-700 mb-2">2. Diet Description?</label><select id="diet" name="diet" class="w-full rounded-lg border-gray-300 p-3 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50"><option value="vegan">Vegan</option><option value="vegetarian">Vegetarian</option><option value="pescatarian">Pescatarian</option><option value="low_meat" selected>Low Meat</option><option value="high_meat">High Meat</option></select></div>
                        <div><label for="energy" class="block text-lg font-semibold text-gray-700 mb-2">3. Home Energy Usage?</label><select id="energy" name="energy" class="w-full rounded-lg border-gray-300 p-3 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50"><option value="very_conscious">Very Conscious</option><option value="somewhat_conscious" selected>Somewhat Conscious</option><option value="not_conscious">Not Very Conscious</option></select></div>
                        <button type="submit" class="flex w-full items-center justify-center rounded-lg bg-primary p-3 text-lg font-semibold text-white shadow-lg transition hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light focus:ring-opacity-75"><i data-lucide="calculator" class="mr-2 h-5 w-5"></i> Calculate</button>
                    </form>
                    <div id="calculator-result" class="hidden rounded-xl bg-secondary p-6 text-center shadow-inner opacity-0"><h3 class="text-xl font-semibold text-primary">Estimated Footprint:</h3><p id="footprint-value" class="my-3 text-4xl font-bold text-primary-dark"></p><p id="footprint-comparison" class="text-gray-700"></p><p class="mt-4 text-sm text-gray-600">Want to improve? Try an <a href="#" class="nav-item font-medium text-primary-light hover:underline" data-page="dashboard">Eco Challenge</a>!</p></div>
                </div>

                <!-- ECOBOT PAGE -->
                <div id="page-ecobot" class="page-content hidden">
                    <div class="flex h-[calc(100vh-10rem)] flex-col rounded-xl bg-white shadow-lg">
                        <div class="flex items-center space-x-3 border-b p-4"><div class="relative flex h-12 w-12 items-center justify-center rounded-full bg-primary-light"><i data-lucide="bot" class="h-6 w-6 text-white"></i><span class="absolute -bottom-1 -right-1 rounded-full border-2 border-white bg-green-500 p-1.5"></span></div><div><h3 class="text-lg font-semibold text-gray-800">EcoBot</h3><p class="text-sm text-green-600">Online</p></div></div>
                        <div id="chat-window" class="flex-1 space-y-4 overflow-y-auto p-6"><div class="flex"><div class="chat-bubble chat-bubble-bot">Hello! I'm EcoBot. Ask me about ecology, sustainability, or your courses!</div></div><div id="bot-typing" class="flex hidden"><div class="chat-bubble chat-bubble-bot"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div></div>
                        <form id="chat-form" class="flex items-center space-x-2 border-t bg-gray-50 p-4"><input type="text" id="chat-input" placeholder="Type your message..." class="flex-1 rounded-full border-gray-300 p-3 px-5 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50" autocomplete="off"><button type="submit" class="flex h-12 w-12 items-center justify-center rounded-full bg-primary text-white transition hover:bg-primary-dark"><i data-lucide="send" class="h-6 w-6"></i></button></form>
                    </div>
                </div>

                <!-- LEADERBOARD PAGE -->
                <div id="page-leaderboard" class="page-content hidden space-y-6">
                     <div class="rounded-xl bg-white p-6 text-center shadow-lg"><i data-lucide="award" class="mx-auto h-16 w-16 text-accent"></i><h2 class="mt-4 text-3xl font-bold text-gray-800">Top Students</h2><p class="mt-2 text-gray-600">See who's leading the way!</p></div>
                     <div class="overflow-hidden rounded-xl bg-white shadow-lg"><table class="w-full text-left"><thead class="border-b bg-gray-50"><tr><th class="px-6 py-3 text-sm font-semibold text-gray-600">Rank</th><th class="px-6 py-3 text-sm font-semibold text-gray-600">Student</th><th class="px-6 py-3 text-sm font-semibold text-gray-600">Green Points</th></tr></thead><tbody class="divide-y divide-gray-200"><tr class="font-semibold hover:bg-gray-50"><td class="px-6 py-4 text-lg"><i data-lucide="trophy" class="mr-2 inline-block h-5 w-5 text-yellow-500"></i>1</td><td class="flex items-center px-6 py-4"><img src="https://placehold.co/40x40/F6E05E/000000?text=A" alt="Avatar" class="h-10 w-10 rounded-full"><span class="ml-3 text-gray-800">Alex Johnson</span></td><td class="px-6 py-4 text-lg text-gray-800">3,450 GP</td></tr><tr class="font-semibold hover:bg-gray-50"><td class="px-6 py-4 text-lg"><i data-lucide="trophy" class="mr-2 inline-block h-5 w-5 text-gray-400"></i>2</td><td class="flex items-center px-6 py-4"><img src="https://placehold.co/40x40/C0C0C0/FFFFFF?text=M" alt="Avatar" class="h-10 w-10 rounded-full"><span class="ml-3 text-gray-800">Maria Garcia</span></td><td class="px-6 py-4 text-lg text-gray-800">3,120 GP</td></tr><tr class="font-semibold hover:bg-gray-50"><td class="px-6 py-4 text-lg"><i data-lucide="trophy" class="mr-2 inline-block h-5 w-5 text-yellow-700"></i>3</td><td class="flex items-center px-6 py-4"><img src="https://placehold.co/40x40/CD7F32/FFFFFF?text=C" alt="Avatar" class="h-10 w-10 rounded-full"><span class="ml-3 text-gray-800">Chen Wei</span></td><td class="px-6 py-4 text-lg text-gray-800">2,980 GP</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-4 text-gray-700">4</td><td class="flex items-center px-6 py-4"><img src="https://placehold.co/40x40/4A90E2/FFFFFF?text=R" alt="Avatar" class="h-10 w-10 rounded-full"><span class="ml-3 text-gray-700">Ravi Patel</span></td><td class="px-6 py-4 text-gray-700">2,500 GP</td></tr><tr id="leaderboard-user-row" class="bg-secondary font-bold ring-2 ring-primary-light hover:bg-green-100"><td class="px-6 py-4 text-primary">5</td><td class="flex items-center px-6 py-4"><img id="leaderboard-user-avatar" src="https://placehold.co/40x40/38A169/FFFFFF?text=S" alt="Avatar" class="h-10 w-10 rounded-full"><span id="leaderboard-user-name" class="ml-3 text-primary">Student (You)</span></td><td id="leaderboard-user-gp" class="px-6 py-4 text-primary">1250 GP</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-4 text-gray-700">6</td><td class="flex items-center px-6 py-4"><img src="https://placehold.co/40x40/E37B40/FFFFFF?text=E" alt="Avatar" class="h-10 w-10 rounded-full"><span class="ml-3 text-gray-700">Emily Davis</span></td><td class="px-6 py-4 text-gray-700">980 GP</td></tr><tr class="hover:bg-gray-50"><td class="px-6 py-4 text-gray-700">7</td><td class="flex items-center px-6 py-4"><img src="https://placehold.co/40x40/8E44AD/FFFFFF?text=S" alt="Avatar" class="h-10 w-10 rounded-full"><span class="ml-3 text-gray-700">Sam Okoye</span></td><td class="px-6 py-4 text-gray-700">760 GP</td></tr></tbody></table></div>
                </div>

                <!-- PROFILE PAGE -->
                <div id="page-profile" class="page-content hidden space-y-6">
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                        <div class="rounded-xl bg-white p-6 text-center shadow-lg lg:col-span-1">
                            <img id="profile-avatar" src="https://placehold.co/128x128/38A169/FFFFFF?text=S" alt="User Avatar" class="mx-auto h-32 w-32 rounded-full border-4 border-primary-light">
                            <h2 id="profile-name-view" class="mt-4 text-2xl font-bold text-gray-800">Student</h2>
                            <input id="profile-name-edit" type="text" class="hidden mt-4 w-full rounded-lg border-gray-300 p-2 text-center text-2xl font-bold text-gray-800 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50" value="Student">
                            <p id="profile-email-view" class="text-gray-500">student@ecostudy.com</p>
                            <input id="profile-email-edit" type="email" class="hidden w-full rounded-lg border-gray-300 p-2 text-center text-gray-500 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50" value="student@ecostudy.com">
                            <p id="profile-title-view" class="mt-2 text-sm text-primary-light">Ecology Enthusiast</p>
                            <input id="profile-title-edit" type="text" class="hidden mt-2 w-full rounded-lg border-gray-300 p-2 text-center text-sm text-primary-light shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50" value="Ecology Enthusiast">
                            <button id="edit-profile-button" data-mode="view" class="mt-6 w-full rounded-lg bg-primary px-4 py-2 font-semibold text-white transition duration-300 hover:bg-primary-dark"><i data-lucide="edit-2" class="mr-2 inline-block h-4 w-4"></i><span>Edit Profile</span></button>
                        </div>
                        <div class="rounded-xl bg-white p-6 shadow-lg lg:col-span-2">
                            <h3 class="mb-4 text-xl font-semibold text-gray-700">About Me</h3>
                            <p id="profile-bio-view" class="text-gray-600">Passionate about renewable energy...</p>
                            <textarea id="profile-bio-edit" class="hidden h-32 w-full rounded-lg border-gray-300 p-2 text-gray-600 shadow-sm focus:border-primary-light focus:ring focus:ring-primary-light focus:ring-opacity-50">Passionate about renewable energy...</textarea>
                            <div class="my-6 border-t border-gray-200"></div>
                            <h3 class="mb-4 text-xl font-semibold text-gray-700">My Eco Badges</h3>
                            <div id="badge-display" class="flex flex-wrap gap-4">
                                <span class="badge badge-bronze" title="Eco Starter (1000+ GP)"><i data-lucide="sprout" class="h-6 w-6"></i></span>
                                <span class="badge" title="Eco Aware (2500+ GP)"><i data-lucide="leaf" class="h-6 w-6"></i></span>
                                <span class="badge" title="Eco Champion (5000+ GP)"><i data-lucide="award" class="h-6 w-6"></i></span>
                                <span class="badge" title="Eco Hero (10000+ GP)"><i data-lucide="shield-check" class="h-6 w-6"></i></span>
                            </div>
                            <div class="my-6 border-t border-gray-200"></div>
                            <h3 class="mb-4 text-xl font-semibold text-gray-700">My EcoStudy Stats</h3>
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                                <div class="rounded-lg bg-secondary p-4 text-center"><i data-lucide="leaf" class="mx-auto h-8 w-8 text-primary-light"></i><p id="profile-gp" class="mt-2 text-xl font-bold text-primary">1250</p><p class="text-sm text-gray-600">Green Points</p></div>
                                <div class="rounded-lg bg-secondary p-4 text-center"><i data-lucide="check-circle" class="mx-auto h-8 w-8 text-blue-500"></i><p class="mt-2 text-xl font-bold text-blue-600">5</p><p class="text-sm text-gray-600">Courses Done</p></div>
                                <div class="rounded-lg bg-secondary p-4 text-center"><i data-lucide="file-up" class="mx-auto h-8 w-8 text-indigo-500"></i><p id="profile-files" class="mt-2 text-xl font-bold text-indigo-600">12</p><p class="text-sm text-gray-600">Files Uploaded</p></div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // --- Icon Rendering ---
        function renderLucideIconsInternal() { if (typeof lucide !== 'undefined' && lucide.icons && typeof lucide.createIcons === 'function') { try { lucide.createIcons(); } catch (error) { console.error("Error creating Lucide icons:", error); } } else { console.error("Attempted to render Lucide icons, but library is not ready."); } }
        let lucideCheckInterval = null; let lucideCheckAttempts = 0; const MAX_LUCIDE_CHECKS = 20;
        function initializeIconsWhenReady() { if (typeof lucide !== 'undefined' && lucide.icons && typeof lucide.createIcons === 'function') { console.log("Lucide ready on initial check. Rendering icons."); renderLucideIconsInternal(); if (lucideCheckInterval) clearInterval(lucideCheckInterval); } else { console.log("Lucide not ready yet. Starting polling check..."); if (lucideCheckInterval) clearInterval(lucideCheckInterval); lucideCheckAttempts = 0; lucideCheckInterval = setInterval(() => { lucideCheckAttempts++; if (typeof lucide !== 'undefined' && lucide.icons && typeof lucide.createIcons === 'function') { console.log("Lucide ready after polling. Rendering icons."); clearInterval(lucideCheckInterval); renderLucideIconsInternal(); } else if (lucideCheckAttempts >= MAX_LUCIDE_CHECKS) { clearInterval(lucideCheckInterval); console.error("Lucide library failed to initialize after multiple checks."); } }, 100); } }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selectors ---
            const loginPage = document.getElementById('login-page');
            const mainApp = document.getElementById('main-app');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-button');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const burgerBtn = document.getElementById('burger-btn');
            const navItems = document.querySelectorAll('.nav-item');
            const pageContents = document.querySelectorAll('.page-content');
            const pageTitle = document.getElementById('page-title');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            const switchAccountButton = document.getElementById('switch-account-button');
            const dropdownUsername = document.getElementById('dropdown-username');
            const dropdownEmail = document.getElementById('dropdown-email');
            const userAvatarHeader = document.getElementById('user-avatar-header'); // Avatar in header
            const profileAvatar = document.getElementById('profile-avatar'); // Avatar on profile page
            const welcomeUsername = document.getElementById('welcome-username'); // Welcome message
            const fileUpload = document.getElementById('file-upload');
            const dropzone = document.getElementById('dropzone');
            const fileList = document.getElementById('file-list');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');
            const botTyping = document.getElementById('bot-typing');
            const greenPointsDisplay = document.getElementById('green-points-display');
            const dashboardGP = document.getElementById('dashboard-gp');
            const profileGP = document.getElementById('profile-gp');
            const dashboardFiles = document.getElementById('dashboard-files');
            const profileFiles = document.getElementById('profile-files');
            const leaderboardUserGP = document.getElementById('leaderboard-user-gp');
            const leaderboardUserAvatar = document.getElementById('leaderboard-user-avatar');
            const leaderboardUserName = document.getElementById('leaderboard-user-name');
            const materialsMainView = document.getElementById('materials-main-view'); // Changed ID reference
            const courseGridContainer = document.getElementById('course-grid-container'); // Container for dynamic cards
            const courseSearchInput = document.getElementById('course-search');
            const noCoursesMessage = document.getElementById('no-courses-message');
            const courseDetailsView = document.getElementById('course-details-view');
            // const courseLinks = document.querySelectorAll('.course-link'); // Remove this, links are dynamic now
            const backToCoursesBtn = document.getElementById('back-to-courses-btn');
            const courseDetailTitle = document.getElementById('course-detail-title');
            const courseDetailDesc = document.getElementById('course-detail-desc');
            const courseDetailProgress = document.getElementById('course-detail-progress');
            const courseModuleList = document.getElementById('course-module-list');
            const courseContentTitle = document.getElementById('course-content-title');
            const courseContentText = document.getElementById('course-content-text');
            const videoPlayerPlaceholder = document.getElementById('video-player-placeholder'); // Get video placeholder
            const ecoTipLoader = document.getElementById('eco-tip-loader');
            const ecoTipText = document.getElementById('eco-tip-text');
            const ecoTipError = document.getElementById('eco-tip-error');
            const editProfileButton = document.getElementById('edit-profile-button');
            const profileNameView = document.getElementById('profile-name-view');
            const profileNameEdit = document.getElementById('profile-name-edit');
            const profileEmailView = document.getElementById('profile-email-view');
            const profileEmailEdit = document.getElementById('profile-email-edit');
            const profileTitleView = document.getElementById('profile-title-view');
            const profileTitleEdit = document.getElementById('profile-title-edit');
            const profileBioView = document.getElementById('profile-bio-view');
            const profileBioEdit = document.getElementById('profile-bio-edit');
            const badgeDisplay = document.getElementById('badge-display');
            const carbonCalculatorForm = document.getElementById('carbon-calculator-form');
            const calculatorResultDiv = document.getElementById('calculator-result');
            const footprintValue = document.getElementById('footprint-value');
            const footprintComparison = document.getElementById('footprint-comparison');
            const challengeButtons = document.querySelectorAll('.join-challenge-btn'); // Select challenge buttons
            const challengeMessage = document.getElementById('challenge-message'); // Message area

            // --- State ---
            let currentPage = 'dashboard';
            let currentUser = { name: 'Student', email: 'student@ecostudy.com', title: 'Ecology Enthusiast', bio: "Passionate about renewable energy, sustainable agriculture, and protecting biodiversity. I'm here to learn as much as I can about our planet and how we can protect it for future generations.", greenPoints: 1250, filesUploaded: 12, completedModules: new Set(['eco1', 'ren1']), // Example completed modules
                joinedChallenges: new Set() // Track joined challenges
            };

            // --- ALL Mock Course Data (Expanded with video flags) ---
            const allCourses = {
                 'ecology': { title: 'Introduction to Ecology', icon: 'sun-moon', color: 'primary-light', description: 'Learn the fundamental principles...', progress: '75%', modules: [ { id: 'eco1', title: 'Module 1: What is Ecology?', hasVideo: true, status: 'default', icon: 'book' }, { id: 'eco2', title: 'Module 2: Ecosystems', hasVideo: true, status: 'default', icon: 'book' }, { id: 'eco3', title: 'Module 3: Biodiversity', hasVideo: false, status: 'default', icon: 'book' }, { id: 'eco4', title: 'Module 4: Final Quiz', hasVideo: false, status: 'default', icon: 'book' } ], content: { 'Module 1: What is Ecology?': 'Ecology is...', 'Module 2: Ecosystems': 'An ecosystem includes...', 'Module 3: Biodiversity': 'Biodiversity is...', 'Module 4: Final Quiz': 'Test your knowledge...' } },
                 'renewable': { title: 'Renewable Energy', icon: 'wind', color: 'blue-500', description: 'Explore solar, wind...', progress: '40%', modules: [ { id: 'ren1', title: 'Module 1: Solar Power', hasVideo: true, status: 'default', icon: 'book' }, { id: 'ren2', title: 'Module 2: Wind Energy', hasVideo: true, status: 'default', icon: 'book' }, { id: 'ren3', title: 'Module 3: Geothermal', hasVideo: false, status: 'default', icon: 'book' } ], content: { 'Module 1: Solar Power': 'Solar power is...', 'Module 2: Wind Energy': 'Wind energy...', 'Module 3: Geothermal': 'Geothermal energy is...' } },
                 'agriculture': { title: 'Sustainable Agriculture', icon: 'sprout', color: 'green-600', description: 'Discover methods for farming...', progress: '10%', modules: [ { id: 'agr1', title: 'Module 1: Introduction', hasVideo: true, status: 'default', icon: 'book' }, { id: 'agr2', title: 'Module 2: Soil Health', hasVideo: false, status: 'locked', icon: 'lock' }, { id: 'agr3', title: 'Module 3: Water Mgt.', hasVideo: false, status: 'locked', icon: 'lock' } ], content: { 'Module 1: Introduction': 'Sustainable agriculture is...', 'Module 2: Soil Health': 'Soil health is... (Content locked).', 'Module 3: Water Mgt.': 'Sustainable water management... (Content locked).' } },
                 'climate': { title: 'Climate Change Science', icon: 'thermometer-sun', color: 'red-500', description: 'Understand the causes and effects...', progress: '0%', modules: [ { id: 'cli1', title: 'Module 1: Greenhouse Effect', hasVideo: true, status: 'default', icon: 'book' } ], content: { 'Module 1: Greenhouse Effect': 'The greenhouse effect is...' } },
                 'conservation': { title: 'Wildlife Conservation', icon: 'paw-print', color: 'yellow-600', description: 'Learn about protecting endangered species...', progress: '25%', modules: [ { id: 'con1', title: 'Module 1: Threats', hasVideo: true, status: 'default', icon: 'book' } ], content: { 'Module 1: Threats': 'Major threats include...' } },
                 'waste': { title: 'Waste Management & Recycling', icon: 'recycle', color: 'purple-500', description: 'Explore reducing, reusing, and recycling...', progress: '5%', modules: [ { id: 'was1', title: 'Module 1: The 3 Rs', hasVideo: false, status: 'default', icon: 'book' } ], content: { 'Module 1: The 3 Rs': 'Reduce, Reuse, Recycle...' } },
                 'ocean': { title: 'Oceanography & Marine Life', icon: 'anchor', color: 'cyan-600', description: 'Dive into the study of oceans...', progress: '15%', modules: [ { id: 'oce1', title: 'Module 1: Ocean Zones', hasVideo: true, status: 'default', icon: 'book' } ], content: { 'Module 1: Ocean Zones': 'Epipelagic, Mesopelagic...' } },
                 'policy': { title: 'Environmental Policy', icon: 'landmark', color: 'gray-600', description: 'Examine laws and regulations...', progress: '0%', modules: [ { id: 'pol1', title: 'Module 1: Key Legislation', hasVideo: false, status: 'default', icon: 'book' } ], content: { 'Module 1: Key Legislation': 'Clean Air Act, Clean Water Act...' } },
                 'urban': { title: 'Urban Ecology', icon: 'building', color: 'slate-500', description: 'Study ecosystems in cities...', progress: '0%', modules: [ { id: 'urb1', title: 'Module 1: Green Spaces', hasVideo: true, status: 'default', icon: 'book' } ], content: { 'Module 1: Green Spaces': 'Importance of parks...' } },
            };


            // --- Functions ---

            // ... (keep updateUserDisplays, awardGreenPoints, updateBadges, callGeminiAPI, fetchEcoTip, toggleMobileMenu) ...
             function updateUserDisplays() {
                const gpString = currentUser.greenPoints.toLocaleString();
                const fileString = currentUser.filesUploaded.toLocaleString();
                const userInitial = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U';
                const avatarUrl = `https://placehold.co/40x40/38A169/FFFFFF?text=${userInitial}`;
                const profileAvatarUrl = `https://placehold.co/128x128/38A169/FFFFFF?text=${userInitial}`;

                if (greenPointsDisplay) greenPointsDisplay.textContent = gpString;
                if (dashboardGP) dashboardGP.textContent = gpString;
                if (profileGP) profileGP.textContent = gpString;
                if (leaderboardUserGP) leaderboardUserGP.textContent = `${gpString} GP`;
                if (dashboardFiles) dashboardFiles.textContent = fileString;
                if (profileFiles) profileFiles.textContent = fileString;
                if (welcomeUsername) welcomeUsername.textContent = currentUser.name;
                if (dropdownUsername) dropdownUsername.textContent = currentUser.name;
                if (dropdownEmail) dropdownEmail.textContent = currentUser.email;
                if (leaderboardUserName) leaderboardUserName.textContent = `${currentUser.name} (You)`;

                // Update Avatars
                if (userAvatarHeader) userAvatarHeader.src = avatarUrl;
                if (profileAvatar) profileAvatar.src = profileAvatarUrl;
                if (leaderboardUserAvatar) leaderboardUserAvatar.src = avatarUrl;

                updateBadges();
            }

            function awardGreenPoints(points) { currentUser.greenPoints += points; updateUserDisplays(); } // Changed to call updateUserDisplays

            function updateBadges() {
                if (!badgeDisplay) return; const badges = badgeDisplay.querySelectorAll('.badge'); const gp = currentUser.greenPoints; let iconsNeedUpdate = false; badges.forEach(badge => { const title = badge.getAttribute('title') || ''; let threshold = 0; let targetIconClass = ''; let badgeClass = ''; const iconElement = badge.querySelector('i, svg'); const currentIcon = iconElement ? iconElement.getAttribute('data-lucide') : null; if (title.includes('Eco Starter')) { threshold = 1000; targetIconClass = 'sprout'; badgeClass = 'badge-bronze'; } else if (title.includes('Eco Aware')) { threshold = 2500; targetIconClass = 'leaf'; badgeClass = 'badge-silver'; } else if (title.includes('Eco Champion')) { threshold = 5000; targetIconClass = 'award'; badgeClass = 'badge-gold'; } else if (title.includes('Eco Hero')) { threshold = 10000; targetIconClass = 'shield-check'; badgeClass = 'badge-emerald'; } if (gp >= threshold) { badge.classList.remove('opacity-30', 'grayscale', 'bg-gray-200'); badge.classList.add(badgeClass); if (iconElement && currentIcon !== targetIconClass) { iconElement.setAttribute('data-lucide', targetIconClass); iconsNeedUpdate = true; } } else { badge.classList.add('opacity-30', 'grayscale', 'bg-gray-200'); badge.classList.remove('badge-bronze', 'badge-silver', 'badge-gold', 'badge-emerald'); if (iconElement && currentIcon !== targetIconClass) { iconElement.setAttribute('data-lucide', targetIconClass); iconsNeedUpdate = true; } } }); if (iconsNeedUpdate) { renderLucideIconsInternal(); }
            }

            async function callGeminiAPI(userQuery, systemPrompt, retries = 3, delay = 1000) { const apiKey = "AIzaSyAVwgQHycQ9VWoYpRbGx2AHXXhyKbZYKY0"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, }; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { if (response.status === 429 && retries > 0) { await new Promise(resolve => setTimeout(resolve, delay)); return callGeminiAPI(userQuery, systemPrompt, retries - 1, delay * 2); } if (response.status === 400 || response.status === 403) { console.error(`API Key Error: ${response.statusText} (Status: ${response.status}). Check key.`); } else { console.error(`API Error: ${response.statusText} (Status: ${response.status})`); } throw new Error(`API Error: ${response.statusText} (Status: ${response.status})`); } const result = await response.json(); const candidate = result.candidates?.[0]; if (candidate && candidate.content?.parts?.[0]?.text) { return candidate.content.parts[0].text; } else if (result.promptFeedback?.blockReason) { console.warn(`Gemini response blocked. Reason: ${result.promptFeedback.blockReason}`); return `My response was blocked due to safety settings. Reason: ${result.promptFeedback.blockReason}. Please try rephrasing your request.`; } else { console.error("Invalid response structure:", result); throw new Error("Invalid response structure from API."); } } catch (error) { if (retries > 0) { await new Promise(resolve => setTimeout(resolve, delay)); return callGeminiAPI(userQuery, systemPrompt, retries - 1, delay * 2); } console.error("Gemini API call failed after retries:", error.message); throw new Error("Failed to get response from AI assistant after multiple attempts."); } }
            async function fetchEcoTip() { if (!ecoTipLoader || !ecoTipText || !ecoTipError) return; ecoTipLoader.classList.remove('hidden'); ecoTipText.classList.add('hidden'); ecoTipError.classList.add('hidden'); const systemPrompt = "You are a sustainability expert. Provide a single, unique, and concise sustainability tip (2-3 sentences max) suitable for a student. Be encouraging and positive. Do not use markdown."; const userQuery = "Give me today's eco-tip."; try { const tip = await callGeminiAPI(userQuery, systemPrompt); ecoTipText.textContent = tip; ecoTipText.classList.remove('hidden'); } catch (error) { ecoTipError.textContent = "Could not load tip. " + error.message; ecoTipError.classList.remove('hidden'); } finally { ecoTipLoader.classList.add('hidden'); } }
            function toggleMobileMenu() { sidebar.classList.toggle('-translate-x-full'); overlay.classList.toggle('hidden'); }


            /**
             * Dynamically creates and displays course cards in the grid.
             * @param {Object} coursesToDisplay - An object where keys are course IDs and values are course data.
             */
            function displayCourses(coursesToDisplay) {
                if (!courseGridContainer) return;
                courseGridContainer.innerHTML = ''; // Clear existing cards
                let courseCount = 0;

                for (const courseId in coursesToDisplay) {
                    const course = coursesToDisplay[courseId];
                     // Use Tailwind classes for text color directly
                    const textColorClass = `text-${course.color || 'primary-light'}`;
                    const bgColorClass = `bg-${course.color || 'primary-light'}`; // For progress bar

                    const courseCardHTML = `
                        <div class="rounded-xl bg-white p-6 shadow-lg transition-transform duration-300 hover:scale-105">
                            <i data-lucide="${course.icon || 'book-open'}" class="h-12 w-12 ${textColorClass}"></i>
                            <h3 class="mt-4 text-xl font-bold text-gray-800">${course.title}</h3>
                            <p class="mt-2 text-sm text-gray-600">${course.description}</p>
                            <div class="mt-4">
                                <span class="text-xs font-semibold text-gray-500">Progress</span>
                                <div class="mt-1 w-full rounded-full bg-gray-200">
                                    <div class="rounded-full ${bgColorClass} p-0.5 text-center text-xs font-medium leading-none text-white" style="width: ${course.progress || '0%'}">${course.progress || '0%'}</div>
                                </div>
                            </div>
                            <a href="#" class="course-link mt-4 inline-block font-medium ${textColorClass} hover:underline" data-course="${courseId}">${parseInt(course.progress) > 0 ? 'Continue Learning' : 'Start Course'} &rarr;</a>
                        </div>`;
                    courseGridContainer.innerHTML += courseCardHTML;
                    courseCount++;
                }

                 // Show or hide the "no courses" message
                if (noCoursesMessage) {
                    noCoursesMessage.classList.toggle('hidden', courseCount > 0);
                }


                // Re-attach listeners to the new course links
                attachCourseLinkListeners();
                renderLucideIconsInternal(); // Render icons for the new cards
            }

            /**
             * Filters courses based on the search term and displays them.
             * @param {string} searchTerm - The text entered in the search bar.
             */
            function filterCourses(searchTerm) {
                const lowerSearchTerm = searchTerm.toLowerCase().trim();
                const filtered = {};
                let count = 0;

                if (!lowerSearchTerm) {
                    // If search is empty, show default (first 3)
                    for (const courseId in allCourses) {
                        if (count < 3) {
                            filtered[courseId] = allCourses[courseId];
                            count++;
                        } else {
                            break;
                        }
                    }
                } else {
                    // Filter based on search term
                    for (const courseId in allCourses) {
                        const course = allCourses[courseId];
                        if (course.title.toLowerCase().includes(lowerSearchTerm) || course.description.toLowerCase().includes(lowerSearchTerm)) {
                            filtered[courseId] = course;
                        }
                    }
                }
                displayCourses(filtered);
            }

            /**
              * Attaches click listeners to dynamically generated course links.
              */
             function attachCourseLinkListeners() {
                 const courseLinks = courseGridContainer.querySelectorAll('.course-link');
                 courseLinks.forEach(link => {
                     // Remove existing listener to prevent duplicates if re-attaching
                     link.removeEventListener('click', handleCourseLinkClick);
                     link.addEventListener('click', handleCourseLinkClick);
                 });
             }

             /**
              * Handles clicks on course links.
              * @param {Event} e - The click event.
              */
             function handleCourseLinkClick(e) {
                 e.preventDefault();
                 const courseId = e.currentTarget.dataset.course;
                 if (courseId) {
                     showCourse(courseId);
                 }
             }

            function showPage(pageId) {
                pageContents.forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) targetPage.classList.remove('hidden');
                navItems.forEach(item => { item.classList.remove('active'); if (item.dataset.page === pageId) item.classList.add('active'); });
                let title = ''; const sidebarLink = document.querySelector(`#sidebar .nav-item[data-page="${pageId}"]`); if (sidebarLink && sidebarLink.querySelector('span')) { title = sidebarLink.querySelector('span').textContent; } else if (pageId === 'profile') { title = 'My Profile'; } else { title = pageId.charAt(0).toUpperCase() + pageId.slice(1); } pageTitle.textContent = title; currentPage = pageId;

                // Reset specific page states if needed
                if (pageId === 'materials') {
                    showMaterialsMainView(); // Ensure main view is shown
                    if (courseSearchInput) courseSearchInput.value = ''; // Clear search on page load
                    filterCourses(''); // Display default courses
                } else {
                    showMaterialsMainView(); // Hide course details if navigating away
                }


                if (!sidebar.classList.contains('-translate-x-full')) toggleMobileMenu();
                if (userMenuDropdown && !userMenuDropdown.classList.contains('hidden')) userMenuDropdown.classList.add('hidden');
                renderLucideIconsInternal();
             }

            // Renamed function to avoid conflict
            function showMaterialsMainView() {
                if (materialsMainView && courseDetailsView) {
                    courseDetailsView.classList.add('hidden');
                    materialsMainView.classList.remove('hidden');
                }
                 // Reset title when going back to the main materials view
                if (pageTitle && currentPage === 'materials') {
                    pageTitle.textContent = 'Study Materials';
                }
            }

            // Modified showCourse to handle video placeholder visibility
            function showCourse(courseId) {
                 const course = allCourses[courseId]; // Use allCourses here
                 if (!course || !materialsMainView || !courseDetailsView || !pageTitle || !courseModuleList) return;
                 materialsMainView.classList.add('hidden'); // Hide main view
                 courseDetailsView.classList.remove('hidden'); // Show details view
                 pageTitle.textContent = course.title; courseDetailTitle.textContent = course.title; courseDetailDesc.textContent = course.description; courseDetailProgress.style.width = course.progress; courseDetailProgress.textContent = course.progress;
                 const progressBgColorClass = `bg-${course.color || 'primary-light'}`;
                 courseDetailProgress.className = `rounded-full p-0.5 text-center text-xs font-medium leading-none text-white transition-all duration-500 ${progressBgColorClass}`;

                 courseModuleList.innerHTML = '';
                 let firstAvailableModule = null;
                 course.modules.forEach(module => {
                     // ... (module list generation logic remains the same) ...
                     let itemClass = 'text-gray-700 hover:bg-gray-50'; let iconColor = 'text-gray-500'; let isClickable = true;
                     const isCompleted = currentUser.completedModules.has(module.id);
                     let displayStatus = module.status === 'locked' ? 'locked' : (isCompleted ? 'completed' : 'active');
                     let currentIcon = module.icon;
                     if (displayStatus === 'active') { itemClass = 'text-gray-700 hover:bg-gray-50'; iconColor = 'text-gray-500'; currentIcon = 'play-circle'; if (!firstAvailableModule) firstAvailableModule = module; } else if (displayStatus === 'completed') { itemClass = 'text-gray-500 hover:bg-gray-50'; iconColor = 'text-primary-light'; currentIcon = 'check-circle'; if (!firstAvailableModule) firstAvailableModule = module; } else if (displayStatus === 'locked') { itemClass = 'text-gray-400 cursor-not-allowed'; iconColor = 'text-gray-400'; isClickable = false; currentIcon = 'lock'; }
                     // Include hasVideo in data attribute
                     const moduleHtml = `<li class="module-item flex items-center p-3 text-sm font-medium rounded-lg ${isClickable ? 'cursor-pointer' : ''} ${itemClass}" data-module-id="${module.id}" data-module-title="${module.title}" data-status="${displayStatus}" data-has-video="${module.hasVideo}" ${!isClickable ? 'disabled' : ''}><i data-lucide="${currentIcon}" class="mr-3 h-5 w-5 ${iconColor}"></i><span>${module.title}</span></li>`;
                     courseModuleList.innerHTML += moduleHtml;
                 });

                 // Set initial content and video visibility
                 if (firstAvailableModule && course.content[firstAvailableModule.title]) {
                    courseContentTitle.textContent = firstAvailableModule.title;
                    courseContentText.textContent = course.content[firstAvailableModule.title];
                    // Show/hide video based on the first available module
                    videoPlayerPlaceholder.classList.toggle('hidden', !firstAvailableModule.hasVideo);
                    const firstModuleElement = courseModuleList.querySelector(`[data-module-id="${firstAvailableModule.id}"]`);
                    if (firstModuleElement) { firstModuleElement.classList.add('text-white', 'bg-primary'); const iconEl = firstModuleElement.querySelector('i, svg'); if(iconEl) iconEl.classList.add('text-white'); }
                 } else {
                     courseContentTitle.textContent = 'Select a module';
                     courseContentText.textContent = 'Please select an unlocked module from the list.';
                     videoPlayerPlaceholder.classList.add('hidden'); // Hide video if no module selected
                 }

                 addModuleClickListeners(courseId); renderLucideIconsInternal();
             }

             // Update addModuleClickListeners to handle video visibility
             function addModuleClickListeners(courseId) {
                 const course = allCourses[courseId]; if (!course || !courseModuleList) return; // Use allCourses
                 const moduleItems = courseModuleList.querySelectorAll('.module-item');
                 moduleItems.forEach(item => {
                     item.addEventListener('click', (e) => {
                         const clickedItem = e.currentTarget;
                         if (clickedItem.hasAttribute('disabled')) return;
                         const moduleId = clickedItem.dataset.moduleId;
                         const moduleTitle = clickedItem.dataset.moduleTitle;
                         const status = clickedItem.dataset.status;
                         const hasVideo = clickedItem.dataset.hasVideo === 'true'; // Get video flag

                         // Update text content
                         if (course.content[moduleTitle]) {
                             courseContentTitle.textContent = moduleTitle;
                             courseContentText.textContent = course.content[moduleTitle];
                         }

                         // Show/hide video placeholder
                         videoPlayerPlaceholder.classList.toggle('hidden', !hasVideo);

                         // Update highlight and icon logic remains the same
                         moduleItems.forEach(mi => { mi.classList.remove('text-white', 'bg-primary'); const iconEl = mi.querySelector('i, svg'); if(iconEl) iconEl.classList.remove('text-white'); if (mi !== clickedItem && mi.dataset.status === 'completed') { if(iconEl) iconEl.classList.add('text-primary-light'); } });
                         clickedItem.classList.add('text-white', 'bg-primary');
                         const clickedIconEl = clickedItem.querySelector('i, svg');
                         if(clickedIconEl) clickedIconEl.classList.add('text-white');
                         if (!currentUser.completedModules.has(moduleId) && status !== 'completed') { currentUser.completedModules.add(moduleId); awardGreenPoints(50); clickedItem.dataset.status = 'completed'; let iconChanged = false; if (clickedIconEl) { if (clickedIconEl.getAttribute('data-lucide') !== 'check-circle') { clickedIconEl.setAttribute('data-lucide', 'check-circle'); iconChanged = true; } clickedIconEl.classList.add('text-white'); clickedIconEl.classList.remove('text-primary-light'); } if (iconChanged) { renderLucideIconsInternal(); } }
                     });
                 });
             }

            function handleFiles(files) { if (!files || !files.length || !fileList) return; let iconsNeedUpdate = false; Array.from(files).forEach(file => { const compressedSizeMB = (file.size / 1024 / 1024); const originalSizeMB = compressedSizeMB * (1.5 + Math.random()); const compressedSizeStr = compressedSizeMB.toFixed(2); const originalSizeStr = originalSizeMB.toFixed(1); let fileType = file.type; let icon = 'file'; if (fileType.includes('pdf')) { icon = 'file-text'; fileType = 'PDF Document'; } else if (fileType.includes('image')) { icon = 'image'; fileType = 'Image'; } else if (fileType.includes('document') || fileType.includes('word')) { icon = 'file-check-2'; fileType = 'Document'; } const newRowHtml = `<tr class="hover:bg-gray-50"><td class="flex items-center px-4 py-3"><i data-lucide="${icon}" class="h-5 w-5 text-gray-500"></i><span class="ml-3 font-medium text-gray-800">${file.name}</span></td><td class="px-4 py-3 text-sm text-gray-600">${fileType}</td><td class="px-4 py-3 text-sm text-gray-600">${compressedSizeStr} MB <span class="text-xs text-gray-500">(from ${originalSizeStr} MB)</span></td><td class="px-4 py-3"><button class="rounded-md p-2 text-gray-500 transition hover:bg-gray-100 hover:text-primary"><i data-lucide="download" class="h-5 w-5"></i></button><button class="delete-file-btn rounded-md p-2 text-gray-500 transition hover:bg-red-100 hover:text-red-600 ml-1"><i data-lucide="trash-2" class="h-5 w-5"></i></button></td></tr>`; fileList.insertAdjacentHTML('beforeend', newRowHtml); awardGreenPoints(10); currentUser.filesUploaded++; updateUserDisplays(); iconsNeedUpdate = true; }); attachDeleteListeners(); if (iconsNeedUpdate) { renderLucideIconsInternal(); } } // Changed to call updateUserDisplays
            function attachDeleteListeners() { const deleteButtons = fileList.querySelectorAll('.delete-file-btn'); deleteButtons.forEach(button => { button.removeEventListener('click', handleDeleteFile); button.addEventListener('click', handleDeleteFile); }); }
            function handleDeleteFile(e) { const row = e.currentTarget.closest('tr'); if (row) { row.remove(); currentUser.filesUploaded--; updateUserDisplays();} } // Changed to call updateUserDisplays
            function addChatMessage(text, sender) { const messageDiv = document.createElement('div'); messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : ''}`; const bubble = document.createElement('div'); bubble.className = `chat-bubble ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'}`; bubble.textContent = text; messageDiv.appendChild(bubble); if (botTyping && botTyping.parentElement === chatWindow) { chatWindow.insertBefore(messageDiv, botTyping); } else if (chatWindow) { chatWindow.appendChild(messageDiv); } if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; }
            function showBotTyping(show) { if (botTyping && chatWindow) { if (show) { chatWindow.appendChild(botTyping); botTyping.classList.remove('hidden'); } else { botTyping.classList.add('hidden'); } chatWindow.scrollTop = chatWindow.scrollHeight; } }
            function calculateFootprint() { const commuteFactors = { walk_bike: 0.1, public_transport: 1.5, electric_vehicle: 1.0, gas_car_small: 3.5, gas_car_large: 5.0 }; const dietFactors = { vegan: 1.5, vegetarian: 2.0, pescatarian: 2.5, low_meat: 3.5, high_meat: 5.0 }; const energyFactors = { very_conscious: 1.0, somewhat_conscious: 2.0, not_conscious: 3.5 }; const commuteValue = document.getElementById('commute').value; const dietValue = document.getElementById('diet').value; const energyValue = document.getElementById('energy').value; const totalFootprint = (commuteFactors[commuteValue] * 0.4) + (dietFactors[dietValue] * 0.4) + (energyFactors[energyValue] * 0.2); const footprintTonnes = (totalFootprint * 1.5).toFixed(1); footprintValue.textContent = `${footprintTonnes} tonnes CO2e / year`; let comparisonText = ''; const avgFootprint = 16; if (footprintTonnes < avgFootprint / 2) { comparisonText = "That's significantly below the average!"; } else if (footprintTonnes < avgFootprint * 0.9) { comparisonText = "You're below the average. Well done!"; } else if (footprintTonnes < avgFootprint * 1.1) { comparisonText = "Your footprint is around the average."; } else { comparisonText = "Your footprint is above the average."; } footprintComparison.textContent = comparisonText; calculatorResultDiv.classList.remove('hidden'); setTimeout(() => { calculatorResultDiv.classList.remove('opacity-0'); }, 10); }


            // --- Event Listeners ---
            loginForm.addEventListener('submit', (e) => { e.preventDefault(); loginPage.classList.add('hidden'); mainApp.classList.remove('hidden'); mainApp.classList.add('flex'); showPage('dashboard'); fetchEcoTip(); updateUserDisplays(); initializeIconsWhenReady(); });

            function doLogout() { mainApp.classList.add('hidden'); mainApp.classList.remove('flex'); loginPage.classList.remove('hidden'); if (userMenuDropdown && !userMenuDropdown.classList.contains('hidden')) userMenuDropdown.classList.add('hidden'); currentUser = { name: 'Student', email: 'student@ecostudy.com', title: 'Ecology Enthusiast', bio: "Passionate...", greenPoints: 1250, filesUploaded: 12, completedModules: new Set(['eco1', 'ren1']), joinedChallenges: new Set() }; challengeButtons.forEach(btn => { btn.disabled = false; btn.textContent = 'Join Challenge'; }); }
            if (logoutButton) logoutButton.addEventListener('click', (e) => { e.preventDefault(); doLogout(); });
            if (switchAccountButton) switchAccountButton.addEventListener('click', (e) => { e.preventDefault(); doLogout(); });

            if (burgerBtn) burgerBtn.addEventListener('click', toggleMobileMenu);
            if (overlay) overlay.addEventListener('click', toggleMobileMenu);

            if (userMenuButton) { userMenuButton.addEventListener('click', (e) => { e.stopPropagation(); userMenuDropdown.classList.toggle('hidden'); renderLucideIconsInternal(); }); }
            window.addEventListener('click', (e) => { if (userMenuDropdown && !userMenuDropdown.classList.contains('hidden')) { if (userMenuButton && !userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) { userMenuDropdown.classList.add('hidden'); } } });

            navItems.forEach(item => { item.addEventListener('click', (e) => { e.preventDefault(); const pageId = item.dataset.page; if (pageId) showPage(pageId); }); });

            // Course Search Listener
            if (courseSearchInput) {
                courseSearchInput.addEventListener('input', (e) => {
                    filterCourses(e.target.value);
                });
            }

            // Moved listener attachment to displayCourses
            // courseLinks.forEach(link => { link.addEventListener('click', handleCourseLinkClick); });

            if (backToCoursesBtn) {
                backToCoursesBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showMaterialsMainView();
                    // if (pageTitle) pageTitle.textContent = 'Study Materials'; // Reset title - handled in showPage now
                });
            }

             if (dropzone) { dropzone.addEventListener('click', () => fileUpload.click()); dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('border-primary-light', 'bg-secondary'); }); dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.classList.remove('border-primary-light', 'bg-secondary'); }); dropzone.addEventListener('drop', (e) => { e.preventDefault(); dropzone.classList.remove('border-primary-light', 'bg-secondary'); handleFiles(e.dataTransfer.files); }); fileUpload.addEventListener('change', (e) => { handleFiles(e.target.files); }); }

            if (chatForm) { chatForm.addEventListener('submit', async (e) => { e.preventDefault(); const userInput = chatInput.value.trim(); if (userInput) { addChatMessage(userInput, 'user'); chatInput.value = ''; showBotTyping(true); const systemPrompt = "You are EcoBot, a friendly AI for EcoStudy. Your expertise is ecology, sustainability, climate change, and environmental science. Keep answers clear, concise, informative. Use markdown if needed."; try { const botResponse = await callGeminiAPI(userInput, systemPrompt); addChatMessage(botResponse, 'bot'); } catch (error) { addChatMessage(error.message || "Sorry, I encountered an error.", 'bot'); } finally { showBotTyping(false); } } }); }

            if (carbonCalculatorForm) { carbonCalculatorForm.addEventListener('submit', (e) => { e.preventDefault(); calculateFootprint(); }); }

            challengeButtons.forEach(button => { button.addEventListener('click', (e) => { const btn = e.currentTarget; const challengeName = btn.dataset.challengeName; if (!currentUser.joinedChallenges.has(challengeName)) { currentUser.joinedChallenges.add(challengeName); btn.textContent = 'Joined!'; btn.disabled = true; awardGreenPoints(5); if (challengeMessage) { challengeMessage.textContent = `Successfully joined the "${challengeName}" challenge! (+5 GP)`; challengeMessage.classList.remove('hidden', 'opacity-0'); setTimeout(() => { challengeMessage.classList.add('opacity-0'); setTimeout(() => challengeMessage.classList.add('hidden'), 500); }, 3000); } } }); });

            if (editProfileButton) { editProfileButton.addEventListener('click', () => { const mode = editProfileButton.dataset.mode; const buttonIcon = editProfileButton.querySelector('i, svg'); const buttonText = editProfileButton.querySelector('span'); const viewElements = [profileNameView, profileEmailView, profileTitleView, profileBioView]; const editElements = [profileNameEdit, profileEmailEdit, profileTitleEdit, profileBioEdit]; let iconChanged = false; if (mode === 'view') { profileNameEdit.value = currentUser.name; profileEmailEdit.value = currentUser.email; profileTitleEdit.value = currentUser.title; profileBioEdit.value = currentUser.bio; viewElements.forEach(el => el.classList.add('hidden')); editElements.forEach(el => el.classList.remove('hidden')); if (buttonIcon) buttonIcon.remove(); editProfileButton.insertAdjacentHTML('afterbegin', '<i data-lucide="save" class="mr-2 inline-block h-4 w-4"></i>'); buttonText.textContent = 'Save Changes'; editProfileButton.dataset.mode = 'edit'; editProfileButton.classList.remove('bg-primary', 'hover:bg-primary-dark'); editProfileButton.classList.add('bg-accent', 'text-primary', 'hover:bg-yellow-400'); iconChanged = true; } else { currentUser.name = profileNameEdit.value.trim(); currentUser.email = profileEmailEdit.value.trim(); currentUser.title = profileTitleEdit.value.trim(); currentUser.bio = profileBioEdit.value.trim(); profileNameView.textContent = currentUser.name; profileEmailView.textContent = currentUser.email; profileTitleView.textContent = currentUser.title; profileBioView.textContent = currentUser.bio; updateUserDisplays(); viewElements.forEach(el => el.classList.remove('hidden')); editElements.forEach(el => el.classList.add('hidden')); if (buttonIcon) buttonIcon.remove(); editProfileButton.insertAdjacentHTML('afterbegin', '<i data-lucide="edit-2" class="mr-2 inline-block h-4 w-4"></i>'); buttonText.textContent = 'Edit Profile'; editProfileButton.dataset.mode = 'view'; editProfileButton.classList.add('bg-primary', 'hover:bg-primary-dark'); editProfileButton.classList.remove('bg-accent', 'text-primary', 'hover:bg-yellow-400'); iconChanged = true; } if (iconChanged) { renderLucideIconsInternal(); } }); }

            // Initial setup
            attachDeleteListeners();
            updateUserDisplays();
            filterCourses(''); // Display initial default courses

        });

        window.onload = () => { console.log("Window loaded. Initializing Lucide icons when ready."); initializeIconsWhenReady(); };
    </script>

</body>
</html>

